<!DOCTYPE HTML>
<html>

<head>
    <title>Gaze APIs and Heatmap Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://api.gazerecorder.com/GazeCloudAPI.js"></script>
    <script src="https://unpkg.com/mathjs@8.0.1/lib/browser/math.js"></script>
    <script src="./js/Engbert_Kliegl.js"></script>

    <style type="text/css">
        body {
            overflow: hidden;
        }

        img {
            display: block;
            margin-left: auto;
            margin-right: auto;
            margin-top: 5%;
            width: 80%;
        }
        /* #container {
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            height: 100%;
        } */
        #plotting_canvas {
            position: absolute;
            z-index: 99;
        }
    </style>
</head>

<body>
 
    <button id='toggle_bi' type='button' onclick='builtin()'> Use built-in samples </button>
    <button id='toggle_click' type='button' onclick='toggleClick()'> Begin click samples </button>
    <button id='toggle_gazeCloud' type='button' onclick='toggleGazeCloud()'> Begin GazeCloud</button>
    <div id="gazecloudopts" style='display:none'>
        <button id="gc_start" type="button" onclick="GazeCloudAPI.StartEyeTracking();">Start tracking</button>
        <button id="gc_stop" type="button" onclick="GazeCloudAPI.StopEyeTracking();">Stop tracking</button>
    </div>


    <div id="gaze"
        style='position: absolute;display:none;width: 100px;height: 100px;border-radius: 50%;border: solid 2px  rgba(255, 255,255, .2);	box-shadow: 0 0 100px 3px rgba(125, 125,125, .5);	pointer-events: none;	z-index: 999999'>
    </div>
    <div id="container">
        <canvas id="plotting_canvas"></canvas>
        <img id='regression' src='regression.jpg'>
    </div>


    <script>
        let xOffset, yOffset, w,h;

        let fakeGazeX = [];
        let fakeGazeY = [];

        let realGazeX = [];
        let realGazeY = [];

        let timestamp = [];

        let canvas = document.getElementById("plotting_canvas");
        let ctx = canvas.getContext('2d');
        let beginClick = false;
        let beginGazeCloud = false;
        let gazeCounter = 0;

        window.onload = function(){

            //////set callbacks for GazeCloudAPI/////////
            GazeCloudAPI.OnCalibrationComplete = function () {
                console.log('gaze Calibration Complete');
                calibrated = true;
                // var pos = findAbsolutePosition(document.getElementById('container'));
                // hm_left = pos.left;
                // hm_top = pos.top;
            }
            GazeCloudAPI.OnCamDenied = function () { console.log('camera access denied') }
            GazeCloudAPI.OnError = function (msg) { console.log('err: ' + msg) }
            GazeCloudAPI.UseClickRecalibration = true;
            GazeCloudAPI.OnResult = PlotGaze;

            //////set canvas//////
            let img = document.getElementById("regression");

            xOffset = img.offsetLeft;
            yOffset = img.offsetTop;
            w = img.clientWidth;
            h = img.clientHeight;

            // position it over the image
            canvas.style.left = xOffset+'px';
            canvas.style.top = yOffset+'px';
            // make same size as the image
            canvas.setAttribute('width', w+'px');
            canvas.setAttribute('height', h+'px');
        }

        function builtin(){
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Start woth fixations
            // fakeGazeX = [234, 247, 253, 244, 235, 240, 248, 256, 261, 272, 273, 263, 243, 254, 425, 569, 740, 867, 853, 870, 864, 844, 848, 839, 842, 848, 854, 850, 844, 836, 823, 822, 828, 831, 675, 554, 394, 253, 232, 243, 254, 258, 267, 257, 248, 235, 216, 218, 227, 235, 199, 214, 223, 229];
            // fakeGazeY = [179, 177, 183, 187, 191, 199, 198, 193, 192, 192, 201, 203, 212, 209, 232, 272, 316, 391, 405, 410, 415, 419, 411, 405, 397, 395, 391, 386, 386, 388, 395, 405, 408, 415, 453, 471, 490, 527, 540, 552, 540, 537, 552, 564, 568, 563, 552, 544, 527, 523, 535, 563, 567, 571];
            // timestamp = math.range(0, fakeGazeX.length); // exclusive
            // Start with saccade
            fakeGazeX = [924, 749, 579, 345, 290, 267, 283, 294, 295, 260, 255, 257, 271, 277, 283, 293, 283, 273, 425, 563, 732, 895, 867, 866, 872, 874, 870, 856, 856, 853, 852, 852, 853, 837, 825, 829, 833, 837, 841, 678, 509, 275, 241, 232, 208, 215, 229, 253, 263, 246, 225, 217, 210, 209, 215];
            fakeGazeY = [19, 15, 17, 54, 139, 194, 196, 203, 214, 211, 214, 224, 220, 213, 208, 227, 227, 230, 242, 259, 312, 397, 423, 421, 404, 397, 392, 385, 388, 399, 410, 411, 420, 421, 416, 405, 397, 393, 384, 451, 475, 503, 547, 547, 543, 538, 537, 542, 547, 558, 560, 560, 561, 585, 590];
            timestamp = math.range(0, fakeGazeX.length); // exclusive
            // Real Gaze
            // fakeGazeX = [918.5890660592254,564.534396355353,532.7338496583143,543.806104783599,548.0547608200457,528.2276993166287,481.87872437357635,433.59854214123004,413.6427334851936,354.805284738041,335.4932118451025,317.2111161731207,326.99589977220955,339.35562642369024,339.09813211845096,334.076993166287,336.6519362186788,345.5354897494305,343.34678815489747,344.89175398633256,385.4471070615034,398.70806378132113,401.92674259681087,371.02742596810936,360.85640091116176,369.9974487471526,362.015125284738,342.57430523918,326.7384054669704,265.4547608200455,261.59234624145785,265.96974943052396,281.80564920273343,283.09312072892936,284.766833712984,278.32947608200453,263.1373120728929,258.3736674259681,269.703416856492,276.2695216400911,277.2994988610478,280.6469248291572,272.02086560364467,281.2906605922551,311.54624145785874,263.7810478359909,243.18150341685646,216.27334851936217,206.87480637813212,168.2506605922551,164.64574031890663,182.6703416856492,267.25722095671983,467.9740318906606,489.98979498861047,597.6224145785877,591.9575398633257,594.6612300683371,639.9802277904328,687.3591799544419,770.0148519362187,810.1839635535307,876.1025056947608,947.1709339407746,946.9134396355353,931.4637813211846,941.634806378132,914.4691571753985,887.3035079726651,908.6755353075171,901.46569476082,883.3123462414578,891.2946697038724,924.2539407744873,879.8361731207289,853.0567653758542,825.1186332574032,876.1025056947608,870.4376309794989,859.4941230068338,860.65284738041,888.7197266514806,916.6578587699316,928.6313439635535,932.2362642369021,943.3085193621869,974.3365831435078,960.4318906605922,948.0721640091115,936.6136674259681,943.566013667426,893.3546241457859,811.3426879271071,599.4248747152619,446.4732574031891,304.98013667425965,284.6380865603645,260.3048747152619,263.7810478359909,257.0861958997722,255.7987243735763,239.4478359908884,181.64036446469248,186.2752619589977,217.94706150341688,244.98396355353077,248.975125284738,262.3648291571754,246.01394077448748,234.94168564920273,237.51662870159453,232.6242369020501,252.83753986332573,242.9240091116173,241.63653758542137,252.451298405467,541.3599088838268,355.8352619589977,302.7914350797266,256.6999544419134,270.21840546697035,244.34022779043283,319.013576309795,362.65886104783596,376.56355353075173,361.62888382687925,319.9148063781321,287.599271070615,216.65958997722095,226.83061503416855];
            // fakeGazeY = [708.501138952164,414.9576309794988,565.3343052391798,546.6659681093394,503.1494305239179,456.15671981776757,408.0052847380409,363.5875170842824,366.54870159453293,372.2135763097949,371.82733485193614,380.96838268792703,385.3457858769931,385.0882915717539,381.9983599088837,374.40227790432795,370.4111161731206,364.10250569476074,378.90842824601356,391.26815489749424,573.8316173120728,612.1982687927107,583.1014123006833,543.31854214123,509.4580410022778,490.27471526195893,467.2289749430523,465.1690205011389,463.6240546697038,426.41612756264226,435.6859225512528,433.3684738041002,418.82004555808646,406.4603189066058,373.75854214122995,365.00373576309784,361.3988154897493,363.4587699316628,365.6474715261958,367.19243735763087,373.5010478359908,387.01949886104774,385.989521640091,448.818132118451,503.6644191343962,471.73512528473793,478.5587243735762,451.00683371298396,431.95225512528464,397.31927107061495,384.18706150341677,340.67052391799535,411.48145785876983,509.97302961275614,485.63981776765365,383.54332574031883,343.7604555808655,317.3672892938495,262.00601366742586,301.91763097949877,263.4222323462414,270.24583143507965,302.43261958997715,367.19243735763087,390.366924829157,385.3457858769931,382.1271070615033,402.2116628701594,409.0352619589976,401.052938496583,384.83079726651476,374.9172665148063,367.3211845102505,366.29120728929377,451.39307517084274,395.25931662870147,334.2331662870159,364.23125284738035,362.6862870159452,380.58214123006826,388.56446469248283,407.2328018223234,389.07945330296116,394.74432801822314,392.68437357630967,386.11826879271064,372.2135763097949,359.59635535307507,358.05138952164003,372.85731207289285,379.9384054669703,368.737403189066,318.1397722095671,155.53211845102496,58.19927107061494,45.19580865603635,59.35799544419126,56.13931662870149,39.40218678815481,27.299954441913357,-1.5394077448748078,44.03708428246006,160.03826879271062,169.82305239179942,155.53211845102496,188.8776309794988,189.39261958997713,187.0751708428245,194.7999999999999,195.95872437357622,195.701230068337,194.28501138952151,180.76656036446457,183.21275626423682,190.16510250569468,192.09630979498854,366.0337129840546,283.3780410022778,147.93603644646916,176.13166287015935,160.55325740318898,218.10323462414567,123.98906605922542,168.40683371298394,162.87070615034156,148.5797722095671,150.25348519362177,148.70851936218668,148.19353075170835,145.36109339407736];
            // timestamp = [1607231495500,1607231497575,1607231497737,1607231497808,1607231497934,1607231497980,1607231498033,1607231498203,1607231498270,1607231498435,1607231498570,1607231498702,1607231498834,1607231498903,1607231498969,1607231499068,1607231499436,1607231499502,1607231499902,1607231499969,1607231500101,1607231500202,1607231500272,1607231500474,1607231500569,1607231500704,1607231500873,1607231500906,1607231500971,1607231501204,1607231501236,1607231501504,1607231501637,1607231501706,1607231501838,1607231501974,1607231502140,1607231502206,1607231502505,1607231502638,1607231502774,1607231503206,1607231503438,1607231503505,1607231503571,1607231503706,1607231503839,1607231503907,1607231503973,1607231504040,1607231504106,1607231504239,1607231504305,1607231504474,1607231504507,1607231504640,1607231504774,1607231504905,1607231505044,1607231505442,1607231505476,1607231505507,1607231505774,1607231505843,1607231506175,1607231506344,1607231506442,1607231506508,1607231506576,1607231506709,1607231506775,1607231506910,1607231507375,1607231507443,1607231507578,1607231507708,1607231507880,1607231508046,1607231508176,1607231508348,1607231508413,1607231508477,1607231508911,1607231509045,1607231509319,1607231509510,1607231509644,1607231509777,1607231510182,1607231510246,1607231510346,1607231510511,1607231510578,1607231510714,1607231510848,1607231510914,1607231511046,1607231511182,1607231511381,1607231511445,1607231511581,1607231511712,1607231511849,1607231512118,1607231512248,1607231512316,1607231512423,1607231512514,1607231512584,1607231513249,1607231513316,1607231513450,1607231513481,1607231513582,1607231513649,1607231513717,1607231513851,1607231514183,1607231514484,1607231514549,1607231514783,1607231514850,1607231515117,1607231516252,1607231516317,1607231516517,1607231516655,1607231516721,1607231516788,1607231516854]; // not used yet

            fakeGazeX.map( x => x/1413*window.innerWidth);
            fakeGazeY.map( y => y/854*window.innerHeight);

            fakeGazeX.forEach((x, index) => {
                ctx.fillStyle = 'red';
                ctx.beginPath();
                ctx.arc(x, fakeGazeY[index], 5, 0, Math.PI * 2, true);
                ctx.fill();
                ctx.fillText(index, x+5, fakeGazeY[index]+5);
            });

            sleep(100).then(()=>{startFixation(fakeGazeX, fakeGazeY, timestamp)});

        }

        function toggleClick(){
            function clickHandler(e) {
                fakeGazeX.push(e.clientX-xOffset);
                fakeGazeY.push(e.clientY-yOffset);

                ctx.fillStyle = 'red';
                ctx.beginPath();
                ctx.arc(e.clientX-xOffset, e.clientY-yOffset, 5, 0, Math.PI * 2, true);
                ctx.fill();
                ctx.fillText(gazeCounter, e.clientX-xOffset+5, e.clientY-yOffset+5);

                gazeCounter += 1;
            };

            canvas.addEventListener("click", clickHandler);

            let btn = document.getElementById('toggle_click');
            beginClick = !beginClick;

            if (beginClick){
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                btn.innerHTML = 'Stop click samples';
            } else {
                canvas.removeEventListener("click", clickHandler);
                gazeCounter = 0;

                btn.innerHTML = 'Begin click samples';
                console.log('Click record stopped.');
                console.log(fakeGazeX);
                console.log(fakeGazeY);

                sleep(100).then(()=>{startFixation(fakeGazeX, fakeGazeY, [0,1,2])});
            }
        }

        function toggleGazeCloud() {
            let btn = document.getElementById('toggle_gazeCloud');
            beginGazeCloud = !beginGazeCloud;

            if (beginGazeCloud){
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                btn.innerHTML = 'Stop GazeCloud';
                document.getElementById("gazecloudopts").style.display = 'initial';
            } else {
                btn.innerHTML = 'Begin GazeCloud';
                document.getElementById("gazecloudopts").style.display = 'none';
                console.log('Gaze record stopped.');
                console.log(JSON.stringify(realGazeX));
                console.log(JSON.stringify(realGazeY));
                console.log( math.concat( [0], math.diff(timestamp) ));

                sleep(100).then(()=>{startFixation(realGazeX, realGazeY, timestamp)});
            }
        }

        function PlotGaze(GazeData) {
            /*
                GazeData.state // 0: valid gaze data; -1 : face tracking lost, 1 : gaze uncalibrated
                GazeData.docX // gaze x in document coordinates
                GazeData.docY // gaze y in document cordinates
                GazeData.time // timestamp
            */

            var canvasX = GazeData.docX - xOffset;
            var canvasY = GazeData.docY - yOffset;
            var time = GazeData.time;

            if (GazeData.state == 0) {
                realGazeX.push(canvasX);
                realGazeY.push(canvasY);
                timestamp.push(time);

                ctx.fillStyle = 'red';
                ctx.beginPath();
                ctx.arc(canvasX, canvasY, 5, 0, Math.PI * 2, true);
                ctx.fill();
                console.log(`@(${GazeData.docX},${GazeData.docY})`);

                var gaze = document.getElementById("gaze");
                gaze.style.left = GazeData.docX - gaze.clientWidth / 2 + "px";
                gaze.style.top = GazeData.docY - gaze.clientHeight / 2 + "px";
            }
            else {
                console.log(GazeData.state > 0 ? 'gaze uncalibrated' : 'face tracking lost');
            }
        }

        function startFixation(gazeX, gazeY, timestamp){
            let samples = {
                x: gazeX,
                y: gazeY,
                t: timestamp, // not used right now
            }

            let [fixations, saccades] = detectFixations(samples);

            // Visualize fixations
            fixations.forEach((fixation, id) => {
                fixation.draw(ctx);
                fixation.drawId(ctx, id);
                fixation.drawRectArea(ctx);
                console.log(`#${id} fixation, ${Date(fixation.start)}, Duration : ${fixation.duration}ms`);
            });

            // Visualize saccades
            saccades.forEach((saccade, id) => {
                saccade.drawVelocity(ctx);
                console.log(`#${id} saccade`);
            });
        }

        function sleep (time) {
            return new Promise((resolve) => setTimeout(resolve, time));
        }

        // function resize() {
        //     var canvas = document.getElementById('plotting_canvas');
        //     var context = canvas.getContext('2d');
        //     context.clearRect(0, 0, canvas.width, canvas.height);
        //     canvas.width = window.innerWidth;
        //     canvas.height = window.innerHeight;
        // };
        // window.addEventListener('resize', resize, false);
    </script>

</body>

</html>