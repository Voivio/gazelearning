<!DOCTYPE HTML>
<html>

<head>
    <title>Gaze APIs and Heatmap Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://api.gazerecorder.com/GazeCloudAPI.js"></script>
    <script src="https://unpkg.com/mathjs@8.0.1/lib/browser/math.js"></script>
    <script src="./js/Engbert_Kliegl.js"></script>

    <style type="text/css">
        body {
            overflow: hidden;
        }

        img {
            display: block;
            margin-left: auto;
            margin-right: auto;
            margin-top: 5%;
            width: 80%;
        }
        /* #container {
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            height: 100%;
        } */
        #plotting_canvas {
            position: absolute;
            z-index: 99;
        }
    </style>
</head>

<body>
 
    <button id='toggle_bi' type='button' onclick='builtin()'> Use built-in samples </button>
    <button id='toggle_click' type='button' onclick='toggleClick()'> Begin click samples </button>
    <button id='toggle_gazeCloud' type='button' onclick='toggleGazeCloud()'> Begin GazeCloud</button>
    <div id="gazecloudopts" style='display:none'>
        <button id="gc_start" type="button" onclick="GazeCloudAPI.StartEyeTracking();">Start tracking</button>
        <button id="gc_stop" type="button" onclick="GazeCloudAPI.StopEyeTracking();">Stop tracking</button>
    </div>


    <div id="gaze"
        style='position: absolute;display:none;width: 100px;height: 100px;border-radius: 50%;border: solid 2px  rgba(255, 255,255, .2);	box-shadow: 0 0 100px 3px rgba(125, 125,125, .5);	pointer-events: none;	z-index: 999999'>
    </div>
    <div id="container">
        <canvas id="plotting_canvas"></canvas>
        <img id='regression' src='regression.jpg'>
    </div>


    <script>
        let xOffset, yOffset, w,h;

        let fakeGazeX = [];
        let fakeGazeY = [];

        let realGazeX = [];
        let realGazeY = [];

        let timestamp = [];

        let canvas = document.getElementById("plotting_canvas");
        let ctx = canvas.getContext('2d');
        let beginClick = false;
        let beginGazeCloud = false;
        let gazeCounter = 0;

        window.onload = function(){

            //////set callbacks for GazeCloudAPI/////////
            GazeCloudAPI.OnCalibrationComplete = function () {
                console.log('gaze Calibration Complete');
                calibrated = true;
                // var pos = findAbsolutePosition(document.getElementById('container'));
                // hm_left = pos.left;
                // hm_top = pos.top;
            }
            GazeCloudAPI.OnCamDenied = function () { console.log('camera access denied') }
            GazeCloudAPI.OnError = function (msg) { console.log('err: ' + msg) }
            GazeCloudAPI.UseClickRecalibration = true;
            GazeCloudAPI.OnResult = PlotGaze;

            //////set canvas//////
            let img = document.getElementById("regression");

            xOffset = img.offsetLeft;
            yOffset = img.offsetTop;
            w = img.clientWidth;
            h = img.clientHeight;

            // position it over the image
            canvas.style.left = xOffset+'px';
            canvas.style.top = yOffset+'px';
            // make same size as the image
            canvas.setAttribute('width', w+'px');
            canvas.setAttribute('height', h+'px');
        }

        function builtin(){
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Start woth fixations
            // fakeGazeX = [234, 247, 253, 244, 235, 240, 248, 256, 261, 272, 273, 263, 243, 254, 425, 569, 740, 867, 853, 870, 864, 844, 848, 839, 842, 848, 854, 850, 844, 836, 823, 822, 828, 831, 675, 554, 394, 253, 232, 243, 254, 258, 267, 257, 248, 235, 216, 218, 227, 235, 199, 214, 223, 229];
            // fakeGazeY = [179, 177, 183, 187, 191, 199, 198, 193, 192, 192, 201, 203, 212, 209, 232, 272, 316, 391, 405, 410, 415, 419, 411, 405, 397, 395, 391, 386, 386, 388, 395, 405, 408, 415, 453, 471, 490, 527, 540, 552, 540, 537, 552, 564, 568, 563, 552, 544, 527, 523, 535, 563, 567, 571];
            // Start with saccade
            // fakeGazeX = [924, 749, 579, 345, 290, 267, 283, 294, 295, 260, 255, 257, 271, 277, 283, 293, 283, 273, 425, 563, 732, 895, 867, 866, 872, 874, 870, 856, 856, 853, 852, 852, 853, 837, 825, 829, 833, 837, 841, 678, 509, 275, 241, 232, 208, 215, 229, 253, 263, 246, 225, 217, 210, 209, 215];
            // fakeGazeY = [19, 15, 17, 54, 139, 194, 196, 203, 214, 211, 214, 224, 220, 213, 208, 227, 227, 230, 242, 259, 312, 397, 423, 421, 404, 397, 392, 385, 388, 399, 410, 411, 420, 421, 416, 405, 397, 393, 384, 451, 475, 503, 547, 547, 543, 538, 537, 542, 547, 558, 560, 560, 561, 585, 590];
            // Real Gaze
            fakeGazeX = [625.5326651480638,609.5793166287016,614.2109339407745,633.1233712984056,639.041548974943,566.6082004555809,552.3273804100228,473.33257403189066,472.56063781321177,494.1748519362187,520.6779954441913,530.0698861047837,529.9412300683372,530.3271981776765,534.57284738041,531.9997266514806,533.4149430523919,540.2337129840547,545.7659225512527,544.4793621867881,540.4910250569477,540.2337129840547,542.549521640091,540.619681093394,539.0758086560364,539.2044646924829,535.4734396355352,530.3271981776765,531.2277904328018,534.4441913439636,535.0874715261959,534.57284738041,528.3973576309794,523.6370842824601,525.0523006833714,534.9588154897494,545.8945785876992,543.4501138952164,526.9821412300684,530.713166287016,532.9003189066059,523.5084282460136,524.9236446469249,556.5730296127563,597.61430523918,621.0297038724373,638.5269248291571,663.2288838268793,697.5800455580865,708.0011845102506,721.252756264237,758.6916628701593,784.4228701594533,797.0311617312074,806.0370842824602,813.8851025056948,832.1542596810933,842.8327107061504,620.0004555808656,611.7664692482916,727.4282460136674,764.0952164009111,780.6918451025057,785.709430523918,794.4580410022779,809.3821412300684,812.4698861047837,813.3704783599088,812.8558542141229,819.8032801822322,833.6981321184511,816.715535307517,598.1289293849659,666.3166287015945,705.8140318906607,756.633166287016,772.4578587699317,783.522277904328,790.2123917995443,796.5165375854215,801.0194988610479,803.9785876993167,807.8382687927107,812.3412300683372,814.3997266514807,823.2769931662871,826.7507061503418,826.1074259681094,825.5928018223234,824.949521640091,824.4348974943052,827.0080182232346,830.8676993166287,835.3706605922551,838.9730296127564,841.6748063781321,846.306423690205,848.6222323462415,854.1544419134397,858.2714350797268,864.1896127562642,868.9498861047836,871.523006833713,877.4411845102507,887.6050113895217,894.6810933940774,895.5816856492029,902.1431435079726,906.903416856492,912.8215945330296,918.99708428246,923.6287015945331,927.3597266514805,928.003006833713,623.2168564920273,626.9478815489749,673.5213667425968,773.358451025057,825.5928018223234,884.7745785876994,901.2425512528473,914.1081548974944,919.254396355353,932.5059681093394,933.2779043280182,878.7277448747153,593.6259681093394,539.7190888382688,472.68929384965827,448.5019589977221,444.3849658314351,434.2211389521641,433.4492027334852,414.1507972665148,385.71781321184505,361.9164464692483,338.11507972665146,320.6178587699317,300.0328929384966,275.84555808656035,241.751708428246,250.88628701594536,263.49457858769927,268.76947608200453,288.1965375854214,285.10879271070615,283.43626423690205,280.4771753986333,272.2431890660592,279.83389521640095,275.97421412300685,279.83389521640095,282.6643280182233,286.3953530751708,295.91589977220957,302.4773576309795,305.1791343963554,300.2902050113895,264.13785876993165,284.7228246013667,304.66451025056944,303.89257403189066,306.46569476082004,311.99790432801825,308.0095671981777,314.05640091116175,320.7465148063781,322.0330751708428,325.24947608200455,325.63544419134394,339.91626423690207,344.8051936218679,347.6356264236902,375.6826423690205,378.89904328018224];
            fakeGazeY = [113.91863325740312,136.6907517084282,162.55061503416852,207.4515717539863,213.36974943052388,769.8071070615035,901.5508883826878,353.09020501138946,291.97858769931656,253.25312072892928,235.24127562642366,212.46915717539855,191.8841913439635,179.66186788154891,182.3636446469248,186.35198177676534,176.96009111617303,177.21740318906603,179.66186788154891,179.14724373576303,178.63261958997714,183.9075170842824,187.38123006833706,188.41047835990884,190.59763097949877,185.83735763097945,184.16482915717535,179.53321184510241,177.60337129840542,183.52154897494296,190.08300683371294,196.90177676537576,198.9602733485193,198.44564920273342,203.0772665148063,208.738132118451,247.84956719817762,914.6738041002277,769.7813758542143,586.7295671981776,405.067243735763,353.4761731207289,323.1133485193621,320.5402277904327,338.68072892938494,355.9206378132118,367.2423690205011,373.1605466970387,368.0143052391799,364.0259681093394,363.2540318906605,376.11963553530745,375.8623234624145,368.14296127562636,363.8973120728929,367.7569931662869,359.26569476082,354.89138952164,1007.3061503416857,991.48145785877,673.4437357630978,575.5364920273348,501.30195899772207,460.13202733485184,436.97394077448735,394.64610478359907,389.24255125284736,380.87990888382683,374.06113895216396,374.5757630979498,368.27161731207286,426.6814578587698,1117.307061503417,763.2456492027336,643.7241913439634,500.1440546697038,461.9332118451025,424.4943052391799,405.58186788154893,394.2601366742596,387.95599088838264,382.5524373576309,374.4471070615034,357.20719817767645,352.3182687927106,339.5813211845102,340.8678815489749,340.35325740318905,337.3941685649202,332.5052391799544,330.0607744874715,335.46432801822317,334.4350797266514,331.2186788154897,334.1777676537585,353.7334851936218,374.3184510250569,382.9384054669703,394.2601366742596,398.2484738041002,399.9210022779042,407.25439635535304,411.37138952164,418.96209567198173,424.3656492027334,422.95043280182233,421.66387243735755,418.96209567198173,421.40656036446467,422.17849658314344,420.6346241457858,418.96209567198173,418.06150341685645,421.66387243735755,1041.3999999999999,1039.8561275626423,888.170660592255,737.2571298405467,660.578132118451,558.9398633257402,520.3430523917995,495.6410933940774,480.459681093394,441.47690205011384,430.5411389521639,532.9513439635535,1093.50569476082,1007.692118451025,762.4737129840548,566.0159453302961,527.0331662870159,503.489111617312,483.9333940774487,471.06779043280176,459.10277904328007,450.2255125284737,454.3425056947607,453.1846013667425,456.78697038724374,920.9779498861047,1139.04993166287,1061.8563097949884,951.7267425968107,778.7358359908885,654.273986332574,618.2502961275626,594.3202733485193,569.2323462414578,508.89266514806377,484.9626423690204,466.3075170842824,451.76938496583136,448.03835990888376,450.3541685649202,445.33658314350794,443.7927107061503,444.56464692482916,550.4485649202733,946.8378132118451,909.7848747152619,775.7252847380411,749.9940774487471,687.8532118451024,527.8051025056947,102.3395899772209,94.23425968109333,25.017312072892878,29.520273348519297,30.034897494305184,31.707425968109277,34.5378587699316,16.26870159453297,14.853485193621793,28.233712984054605,35.43845102505688];
            fakeGazeX.map( x => x/1412*window.innerWidth);
            fakeGazeY.map( y => y/853*window.innerHeight);

            timestamp = [0,1,2]; // not used yet

            fakeGazeX.forEach((x, index) => {
                ctx.fillStyle = 'red';
                ctx.beginPath();
                ctx.arc(x, fakeGazeY[index], 5, 0, Math.PI * 2, true);
                ctx.fill();
                ctx.fillText(index, x+5, fakeGazeY[index]+5);
            });

            sleep(100).then(()=>{startFixation(fakeGazeX, fakeGazeY, timestamp)});

        }

        function toggleClick(){
            function clickHandler(e) {
                fakeGazeX.push(e.clientX-xOffset);
                fakeGazeY.push(e.clientY-yOffset);

                ctx.fillStyle = 'red';
                ctx.beginPath();
                ctx.arc(e.clientX-xOffset, e.clientY-yOffset, 5, 0, Math.PI * 2, true);
                ctx.fill();
                ctx.fillText(gazeCounter, e.clientX-xOffset+5, e.clientY-yOffset+5);

                gazeCounter += 1;
            };

            canvas.addEventListener("click", clickHandler);

            let btn = document.getElementById('toggle_click');
            beginClick = !beginClick;

            if (beginClick){
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                btn.innerHTML = 'Stop click samples';
            } else {
                canvas.removeEventListener("click", clickHandler);
                gazeCounter = 0;

                btn.innerHTML = 'Begin click samples';
                console.log('Click record stopped.');
                console.log(fakeGazeX);
                console.log(fakeGazeY);

                sleep(100).then(()=>{startFixation(fakeGazeX, fakeGazeY, [0,1,2])});
            }
        }

        function toggleGazeCloud() {
            let btn = document.getElementById('toggle_gazeCloud');
            beginGazeCloud = !beginGazeCloud;

            if (beginGazeCloud){
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                btn.innerHTML = 'Stop GazeCloud';
                document.getElementById("gazecloudopts").style.display = 'initial';
            } else {
                btn.innerHTML = 'Begin GazeCloud';
                document.getElementById("gazecloudopts").style.display = 'none';
                console.log('Gaze record stopped.');
                console.log(realGazeX);
                console.log(realGazeY);
                console.log(timestamp);

                sleep(100).then(()=>{startFixation(realGazeX, realGazeY, timestamp)});
            }
        }

        function PlotGaze(GazeData) {
            /*
                GazeData.state // 0: valid gaze data; -1 : face tracking lost, 1 : gaze uncalibrated
                GazeData.docX // gaze x in document coordinates
                GazeData.docY // gaze y in document cordinates
                GazeData.time // timestamp
            */

            var canvasX = GazeData.docX - xOffset;
            var canvasY = GazeData.docY - yOffset;
            var time = GazeData.time;

            if (GazeData.state == 0) {
                realGazeX.push(canvasX);
                realGazeY.push(canvasY);
                timestamp.push(time);

                ctx.fillStyle = 'red';
                ctx.beginPath();
                ctx.arc(canvasX, canvasY, 5, 0, Math.PI * 2, true);
                ctx.fill();
                console.log(`@(${GazeData.docX},${GazeData.docY})`);

                var gaze = document.getElementById("gaze");
                gaze.style.left = GazeData.docX - gaze.clientWidth / 2 + "px";
                gaze.style.top = GazeData.docY - gaze.clientHeight / 2 + "px";
            }
            else {
                console.log(GazeData.state > 0 ? 'gaze uncalibrated' : 'face tracking lost');
            }
        }

        function startFixation(fakeGazeX, fakeGazeY, timestamp){
            let samples = {
                x: fakeGazeX,
                y: fakeGazeY,
                t: timestamp, // not used right now
            }

            let fixations = detectFixations(samples);
            fixations.forEach((fixation, id) => {
                fixation.draw(ctx);
                fixation.drawId(ctx, id);
                fixation.drawRectArea(ctx);
                console.log(`#${id} fixation, ${fixation.start} => ${fixation.end}`);
            });
        }

        function sleep (time) {
            return new Promise((resolve) => setTimeout(resolve, time));
        }

        // function resize() {
        //     var canvas = document.getElementById('plotting_canvas');
        //     var context = canvas.getContext('2d');
        //     context.clearRect(0, 0, canvas.width, canvas.height);
        //     canvas.width = window.innerWidth;
        //     canvas.height = window.innerHeight;
        // };
        // window.addEventListener('resize', resize, false);
    </script>

</body>

</html>