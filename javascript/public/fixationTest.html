<!DOCTYPE HTML>
<html>

<head>
    <title>Gaze APIs and Heatmap Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://api.gazerecorder.com/GazeCloudAPI.js"></script>
    <!-- <script src="https://unpkg.com/mathjs@8.0.1/lib/browser/math.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="js/camera_utils.js"></script>
    <script src="js/gazeClass.js"></script>
    <script src="js/math.js"></script>
    <script src="js/Engbert_Kliegl.js"></script>

    <style type="text/css">
        body {
            overflow: hidden;
        }

        img {
            display: block;
            margin-left: auto;
            margin-right: auto;
            margin-top: 5%;
            width: 80%;
        }

        /* #container {
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            height: 100%;
        } */
        #video_canvas {
            position: absolute;
            z-index: 98;
        }
        #plotting_canvas {
            position: absolute;
            z-index: 99;
        }
        #plotting_svg {
            position: absolute;
            z-index: 98;
        }
    </style>
</head>

<body>

<button id='toggle_bi' type='button' onclick='builtin()'> Use built-in samples</button>
<button id='toggle_click' type='button' onclick='toggleClick()'> Begin click samples</button>
<button id='toggle_gazeCloud' type='button' onclick='toggleGazeCloud()'> Begin GazeCloud</button>
<div id="gazecloudopts" style='display:none'>
    <button id="gc_start" type="button" onclick="GazeCloudAPI.StartEyeTracking();">Start tracking</button>
    <button id="gc_stop" type="button" onclick="GazeCloudAPI.StopEyeTracking();">Stop tracking</button>
</div>
<button id='toggle_faceplusplus' type='button' onclick='toggleFacePlusPlus()'> Begin Face++</button>
<div id="faceplusplusopts" style='display:none'>
    <button id="fpp_start" type="button" onclick="GazeCloudAPI.StartEyeTracking();">Start Face++</button>
    <button id="fpp_stop" type="button" onclick="GazeCloudAPI.StopEyeTracking();">Stop Face++</button>
</div>

<div id="gaze"
     style='position: absolute;display:none;width: 100px;height: 100px;border-radius: 50%;border: solid 2px  rgba(255, 255,255, .2);	box-shadow: 0 0 100px 3px rgba(125, 125,125, .5);	pointer-events: none;	z-index: 999999'>
</div>
<div id="container">
    <video id="input_video" style='display:none;'></video>
    <canvas id="plotting_canvas"></canvas>
    <canvas id="video_canvas" width="320px" height="180px"></canvas>
    <svg id="plotting_svg"></svg>
    <img id='regression' src='media/regression.jpg'>
</div>


<script>
    let xOffset, yOffset, w, h;
    let windowHeight = document.documentElement.clientHeight,
        windowWidth = document.documentElement.clientWidth;

    let fakeGazeX = [];
    let fakeGazeY = [];

    let realGazeX = [];
    let realGazeY = [];

    let timestamp = [];

    let fixations, saccades, AoIs, TMatrix;

    let videoElement = document.getElementById('input_video');
    let videoCanvas = document.getElementById("video_canvas");
    let canvas = document.getElementById("plotting_canvas");
    let ctx = canvas.getContext('2d');
    let svg;
    let beginClick = false;
    let beginGazeCloud = false;
    let gazeCounter = 0;

    let lastGazeTs = -1;

    const fpp_url = 'https://api-cn.faceplusplus.com/facepp/v3/detect';
    const fpp_API_key = '5PxRvIfMnvXCjYh6nCnbAp4-vQuGVQQW';
    const fpp_API_secret = 'vcj_t3_KhOtvvY5I4UT5qZUhHxaYbQeG';

    window.onload = function () {

        //////set callbacks for GazeCloudAPI/////////
        GazeCloudAPI.OnCalibrationComplete = function () {
            console.log('gaze Calibration Complete');
            calibrated = true;
            // var pos = findAbsolutePosition(document.getElementById('container'));
            // hm_left = pos.left;
            // hm_top = pos.top;
        }
        GazeCloudAPI.OnCamDenied = function () {
            console.log('camera access denied')
        }
        GazeCloudAPI.OnError = function (msg) {
            console.log('err: ' + msg)
        }
        GazeCloudAPI.UseClickRecalibration = true;
        GazeCloudAPI.OnResult = PlotGaze;

        //////set canvas//////
        let img = document.getElementById("regression");

        xOffset = img.offsetLeft;
        yOffset = img.offsetTop;
        w = img.clientWidth;
        h = img.clientHeight;

        // position it over the image
        canvas.style.left = xOffset + 'px';
        canvas.style.top = yOffset + 'px';
        videoCanvas.style.left = xOffset + 'px';
        videoCanvas.style.top = yOffset + 'px';
        // make same size as the image
        canvas.setAttribute('width', w+'px');
        canvas.setAttribute('height', h+'px');

        //////set svg//////
        // position it over the image & make same size as the image
        svg = d3.select("#plotting_svg")
            .style('left', xOffset)
            .style('top', yOffset)
            .attr("width", w)
            .attr("height", h)
            .attr("font-family", "sans-serif");

        svg.append("defs");
        let gradient = d3.select("#plotting_svg")
            .select("defs")
            .append("linearGradient")
            .attr("id", "arrowGradient");

        gradient.append("stop")
            .attr("offset", "5%")
            .attr("stop-color", "white");

        gradient.append("stop")
            .attr("offset", "95%")
            .attr("stop-color", "blue");

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                if (collecting !== NOTCOLLECTING) {
                    await dataCollecting();
                } else if (totalConfused === 0 && totalNeutral === 0) {

                }
            },
            width: 320,
            height: 180,
            // deviceId: cameraId,
        });

        drawAnchors()
    }

    function builtin() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawAnchors()
        

        // 0316 real gaze data
        fakeGazeX = [412, 383.2, 445, 202, 196, 191, 153, 128.8, 141.2, 136.2, 105.19999999999999, 31.599999999999994, 112, 111.6, 148, 149.60000000000002, 
        109.80000000000001, 88.6, 42.19999999999999, 44.400000000000006, 50.19999999999999, 45.599999999999994, 65.6, 75.4, 96.80000000000001, 116.4, 112, 
        51.80000000000001, 42.400000000000006, 12.199999999999989, -15.599999999999994, -22.599999999999994, 5, 38.599999999999994, 45.599999999999994, 36.400000000000006, 
        152, 71, -16.400000000000006, -3.5999999999999943, 2.4000000000000057, 90, 96.4, 98.80000000000001, 53, 26.80000000000001, 54.19999999999999, 21, 21, 33, 39, 64.4, 
        169.8, 253.2, 393, 510.6, 524.4, 506.20000000000005, 463.79999999999995, 475.20000000000005, 577.2, 589.8, 559.6, 502, 481.6, 476.20000000000005, 502.20000000000005, 
        503.79999999999995, 492.79999999999995, 482.6, 478.6, 487, 506, 525.4, 568.4, 554.8, 525.8, 547, 561.4, 562.2, 538.4, 544.8, 542.2, 544.2, 556.4, 542.6, 544.4, 548.8, 
        512.4, 516.6, 513.6, 515.8, 520.4, 531, 541.4, 543.2, 524.8, 529, 534.8, 528.6, 539, 519.4, 512.8, 583.4, 712.6, 767.2, 747.4, 681.4, 630.4, 957.5999999999999, 1002, 
        1027.4, 1048, 957.5999999999999, 903, 891.8, 876.2, 872, 884.2, 927.8, 928.2, 936.4000000000001, 949.8, 955.5999999999999, 949, 942, 952, 967.8, 935.4000000000001, 
        972.4000000000001, 1062.8, 1054, 1096.2, 1082, 996.4000000000001, 1116.8, 1152.4, 1133.8, 1105.6, 1073.8, 1010.5999999999999, 985, 1011, 994, 1009.4000000000001, 
        1005.2, 1012.2, 964.8, 992, 1011.8, 981.4000000000001, 932.4000000000001, 982.2, 1040, 1002, 943.2, 924, 864, 867.4, 1085, 1022, 930.2, 968.8, 1008.8, 1019, 
        947.4000000000001, 574, 518, 502.79999999999995, 485, 493.20000000000005, 490, 502.79999999999995, 520.4, 512, 487.4, 485.6, 472.20000000000005, 452, 468.4, 480, 
        473.79999999999995, 467.79999999999995, 482.4, 483.20000000000005, 464.79999999999995, 473, 343.8, 286.8]

        fakeGazeY = [152, 149.8, 79.80000000000001, 103, 136.39999999999998, 110.80000000000001, 106.39999999999998, 103.39999999999998, 116, 130.8, 131, 21, 
        75.60000000000002, 78, 109.80000000000001, 109.80000000000001, 118.60000000000002, 137.8, 85.39999999999998, 126.19999999999999, 99.80000000000001, 137, 
        103.60000000000002, 49, 33.80000000000001, 153.60000000000002, 255.60000000000002, 302.6, 428.79999999999995, 443.20000000000005, 424.4, 444.4, 480, 506, 
        502.6, 478.4, 452, 440, 451, 448.79999999999995, 479.20000000000005, 428.6, 452.20000000000005, 478.6, 528, 535, 503.6, 497, 491.79999999999995, 505.6, 
        437.20000000000005, 387, 357.20000000000005, 164.8, 257, 171, 119.60000000000002, 147.39999999999998, 265.8, 278, 157.2, 190.60000000000002, 224.8, 306, 311.4, 
        326.79999999999995, 326.6, 305.2, 308.4, 316.4, 353.20000000000005, 348.4, 353.20000000000005, 308.4, 285.8, 348.4, 317.4, 296.6, 241.2, 207.60000000000002, 
        212.2, 254.8, 316.6, 335.79999999999995, 342.4, 324.79999999999995, 301.4, 369.6, 487.4, 491, 429.4, 425, 458.20000000000005, 449.79999999999995, 
        416.79999999999995, 336.4, 459.79999999999995, 422.6, 347.20000000000005, 313, 430.4, 466.4, 460.79999999999995, 439.20000000000005, 400.4, 387.20000000000005, 
        389.20000000000005, 412, 416.4, 476, 446.20000000000005, 392.79999999999995, 380.6, 464.79999999999995, 519.2, 534.8, 520.6, 528.8, 522.8, 536.2, 526.8, 534.6, 
        549.8, 512.8, 489.79999999999995, 516, 527.2, 519.6, 502.79999999999995, 514.4, 299.4, 223.8, 232.8, 170.60000000000002, 134.8, 21, -22.19999999999999, 
        -14.400000000000006, 25.400000000000006, 106.39999999999998, 196, 252.8, 185.60000000000002, 166.8, 143, 123.19999999999999, 135, 102.39999999999998, 27, 
        8.800000000000011, 12.199999999999989, 140.8, 173.2, 84.39999999999998, -47.80000000000001, -41, -47.80000000000001, 8.400000000000006, 60.19999999999999, 
        94.60000000000002, 86.39999999999998, 62, 54.400000000000006, 39, 11.400000000000006, 56, 162.2, 155.8, 153, 161.39999999999998, 192.60000000000002, 
        191.39999999999998, 200, 215, 161.39999999999998, 101.39999999999998, 95.19999999999999, 119.60000000000002, 136.8, 116.80000000000001, 115.19999999999999, 
        118.60000000000002, 117.80000000000001, 118.60000000000002, 123.60000000000002, 113, 164.8, 17.19999999999999, -53.80000000000001]

        timestamp = [0, 3985, 515, 567, 534, 533, 502, 500, 532, 503, 527, 504, 568, 521, 597, 516, 535, 500, 621, 510, 538, 514, 
        524, 525, 502, 502, 531, 504, 532, 531, 501, 535, 598, 535, 516, 551, 517, 515, 501, 517, 567, 517, 500, 551, 501, 501, 582, 516, 
        502, 566, 551, 532, 521, 551, 513, 500, 501, 534, 532, 535, 533, 502, 533, 524, 511, 565, 500, 501, 500, 500, 519, 514, 619, 516, 551, 501, 514, 
        502, 517, 501, 515, 500, 529, 506, 532, 502, 533, 501, 651, 534, 1165, 517, 534, 515, 801, 518, 501, 617, 933, 634, 501, 500, 516, 518, 501, 620, 529, 
        551, 532, 501, 500, 533, 518, 517, 501, 500, 537, 583, 547, 500, 534, 533, 533, 502, 500, 533, 501, 534, 533, 522, 512, 567, 500, 501, 533, 561, 506, 500, 
        541, 501, 561, 520, 511, 500, 518, 583, 523, 533, 544, 501, 533, 568, 517, 533, 551, 501, 517, 500, 532, 500, 535, 518, 549, 500, 516, 502, 533, 516, 501, 567, 
        501, 500, 500, 500, 501, 634, 533, 500, 500, 501, 500, 500, 534, 501, 501, 697, 502, 557, 510]
        console.log(fakeGazeX.length, fakeGazeY.length, timestamp.length)
        
        // 0309 real gaze data

        // fakeGazeX = [
        //     497, 173, 159.60000000000002, 171, 197.8, 133.39999999999998, 116.19999999999999, 46.80000000000001, 61.19999999999999, 71.80000000000001, 
        //     69.80000000000001, 88.80000000000001, 119.80000000000001, 96.80000000000001, 84, 85, 90.80000000000001, 137, 123, 167.2, 64.19999999999999, 
        //     70.4, 73, 79.19999999999999, 114.6, 107.6, 78.19999999999999, 74.6, 672, 792.8, 747.8, 771.2, 825.6, 933.8, 957.8, 950.8, 936.2, 936.4000000000001, 
        //     936, 941.2, 931.2, 944.4000000000001, 949.5999999999999, 943.4000000000001, 975.5999999999999, 1007.8, 1067.8, 1052, 1001.4000000000001, 1027.2, 1000.2, 
        //     952.5999999999999, 931.4000000000001, 935.8, 948.2, 960.2, 994.4000000000001, 1026.2, 1055.2, 1039.8, 988.4000000000001, 967.5999999999999, 802.2, 610.8, 
        //     321.8, 180.60000000000002, 184.8, 146, 91.80000000000001, 81.80000000000001, 93.4, 101, 84.19999999999999, 93.4, 93.6, 152.8, 183.60000000000002, 
        //     199.39999999999998, 130, 142.39999999999998, 182, 138.60000000000002, 89.4, 114.80000000000001, 116, 279.2, 361.4, 312.2, 330.2, 322.6, 335.2, 399.6, 477.6, 
        //     460.79999999999995, 463, 450.79999999999995, 503.6, 490.20000000000005, 486.20000000000005, 513.4, 522.6, 516, 526.8, 503, 499.4, 527.8, 532.4, 527.8, 515.6, 
        //     515, 511.4, 428, 400.79999999999995, 492.4, 509, 507, 246, 261.6
        // ]
        // fakeGazeY = [
        //     303, 187, 88.4, 101.80000000000001, 108.19999999999999, 120.39999999999998, 117, 118, 137, 100.80000000000001, 33.400000000000006, 138.60000000000002,
        //      347, 396.4, 467.6, 476.6, 458.79999999999995, 471, 497.6, 557.8, 545, 498.6, 495, 498.4, 525, 555.6, 528.6, 521.4, 466.6, 477, 493.20000000000005, 
        //      493.20000000000005, 502.4, 554.6, 567.6, 569.6, 556, 550.2, 549.8, 543.8, 559.8, 567.4, 584.8, 585.4, 473, 88.4, 45.599999999999994, 40.19999999999999, 
        //      69.6, 118.60000000000002, 86.19999999999999, 73.6, 58.400000000000006, 81.80000000000001, 100.60000000000002, 105.39999999999998, 109, 117.19999999999999, 
        //      139.60000000000002, 122.80000000000001, 89.6, 99.19999999999999, 114.80000000000001, 171.39999999999998, 106, 124, 147.39999999999998, 70.19999999999999, 
        //      45.400000000000006, 52.19999999999999, 65.6, 53, 37.80000000000001, 35.19999999999999, 54.599999999999994, 176.60000000000002, 352.6, 404.6, 533.4, 568, 
        //      555.2, 539.4, 516.4, 513.6, 600.8, 557.6, 513.8, 427.79999999999995, 420.79999999999995, 416, 437.79999999999995, 382.79999999999995, 354, 375.20000000000005, 
        //      383.6, 374.6, 369.20000000000005, 403.79999999999995, 422.20000000000005, 411.79999999999995, 342.8, 292.6, 287.6, 316.2, 316.2, 289.4, 270.6, 280.8, 288, 
        //      299.8, 339, 332.2, 313.8, 266, 269.4, 269.6, -64.2, -86.36
        // ]
        // timestamp = [
        //     0, 3817, 527, 502, 517, 502, 540, 507, 534, 504, 530, 500, 503, 530, 501, 500, 522, 512, 517, 516, 518, 500, 501, 516, 500, 518, 533, 503, 516, 532, 
        //     550, 534, 500, 500, 501, 503, 546, 519, 536, 531, 503, 533, 531, 500, 501, 501, 500, 532, 1301, 500, 501, 566, 500, 552, 520, 596, 533, 571, 508, 591, 
        //     532, 533, 537, 527, 504, 522, 512, 501, 502, 565, 532, 501, 500, 524, 530, 550, 551, 513, 500, 501, 534, 500, 532, 518, 551, 668, 548, 501, 516, 518, 
        //     500, 533, 518, 500, 500, 518, 532, 501, 500, 501, 533, 500, 501, 500, 534, 533, 500, 500, 502, 533, 533, 500, 501, 500, 568, 532, 535, 532
        // ]
        
        let curr = timestamp[0]
        for (let i = 1; i < timestamp.length; i += 1) {
            curr += timestamp[i]
            timestamp[i] = curr
        }

        for (let i = 0; i < fakeGazeX.length; i+=1) {
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(fakeGazeX[i], fakeGazeY[i], 5, 0, Math.PI * 2, true);
            ctx.fill();
            ctx.fillText(i, fakeGazeX[i] + 5, fakeGazeY[i] + 5);
        }

        // Start with fixations
        // fakeGazeX = [234, 247, 253, 244, 235, 240, 248, 256, 261, 272, 273, 263, 243, 254, 425, 569, 740, 867, 853, 870, 864, 844, 848, 839, 842, 848, 854, 850, 844, 836, 823, 822, 828, 831, 675, 554, 394, 253, 232, 243, 254, 258, 267, 257, 248, 235, 216, 218, 227, 235, 199, 214, 223, 229];
        // fakeGazeY = [179, 177, 183, 187, 191, 199, 198, 193, 192, 192, 201, 203, 212, 209, 232, 272, 316, 391, 405, 410, 415, 419, 411, 405, 397, 395, 391, 386, 386, 388, 395, 405, 408, 415, 453, 471, 490, 527, 540, 552, 540, 537, 552, 564, 568, 563, 552, 544, 527, 523, 535, 563, 567, 571];
        // for (let i = 0; i < fakeGazeX.length; i+=1) {
        //     timestamp.push(i);
        // }
        // Start with saccade
        // fakeGazeX = [924, 749, 579, 345, 290, 267, 283, 294, 295, 260, 255, 257, 271, 277, 283, 293, 283, 273, 425, 563, 732, 895, 867, 866, 872, 874, 870, 856, 856, 853, 852, 852, 853, 837, 825, 829, 833, 837, 841, 678, 509, 275, 241, 232, 208, 215, 229, 253, 263, 246, 225, 217, 210, 209, 215];
        // fakeGazeY = [19, 15, 17, 54, 139, 194, 196, 203, 214, 211, 214, 224, 220, 213, 208, 227, 227, 230, 242, 259, 312, 397, 423, 421, 404, 397, 392, 385, 388, 399, 410, 411, 420, 421, 416, 405, 397, 393, 384, 451, 475, 503, 547, 547, 543, 538, 537, 542, 547, 558, 560, 560, 561, 585, 590];
        // for (let i = 0; i < fakeGazeX.length; i+=1) {
        //     timestamp.push(i);
        // }
        // Real Gaze
        // fakeGazeX = [564.534396355353,532.7338496583143,543.806104783599,548.0547608200457,528.2276993166287,481.87872437357635,433.59854214123004,413.6427334851936,354.805284738041,335.4932118451025,317.2111161731207,326.99589977220955,339.35562642369024,339.09813211845096,334.076993166287,336.6519362186788,345.5354897494305,343.34678815489747,344.89175398633256,385.4471070615034,398.70806378132113,401.92674259681087,371.02742596810936,360.85640091116176,369.9974487471526,362.015125284738,342.57430523918,326.7384054669704,265.4547608200455,261.59234624145785,265.96974943052396,281.80564920273343,283.09312072892936,284.766833712984,278.32947608200453,263.1373120728929,258.3736674259681,269.703416856492,276.2695216400911,277.2994988610478,280.6469248291572,272.02086560364467,281.2906605922551,311.54624145785874,263.7810478359909,243.18150341685646,216.27334851936217,206.87480637813212,168.2506605922551,164.64574031890663,182.6703416856492,267.25722095671983,467.9740318906606,489.98979498861047,597.6224145785877,591.9575398633257,594.6612300683371,639.9802277904328,687.3591799544419,770.0148519362187,810.1839635535307,876.1025056947608,947.1709339407746,946.9134396355353,931.4637813211846,941.634806378132,914.4691571753985,887.3035079726651,908.6755353075171,901.46569476082,883.3123462414578,891.2946697038724,924.2539407744873,879.8361731207289,853.0567653758542,825.1186332574032,876.1025056947608,870.4376309794989,859.4941230068338,860.65284738041,888.7197266514806,916.6578587699316,928.6313439635535,932.2362642369021,943.3085193621869,974.3365831435078,960.4318906605922,948.0721640091115,936.6136674259681,943.566013667426,893.3546241457859,811.3426879271071,599.4248747152619,446.4732574031891,304.98013667425965,284.6380865603645,260.3048747152619,263.7810478359909,257.0861958997722,255.7987243735763,239.4478359908884,181.64036446469248,186.2752619589977,217.94706150341688,244.98396355353077,248.975125284738,262.3648291571754,246.01394077448748,234.94168564920273,237.51662870159453,232.6242369020501,252.83753986332573,242.9240091116173,241.63653758542137,252.451298405467,541.3599088838268,355.8352619589977,302.7914350797266,256.6999544419134,270.21840546697035,244.34022779043283,319.013576309795,362.65886104783596,376.56355353075173,361.62888382687925,319.9148063781321,287.599271070615,216.65958997722095,226.83061503416855];
        // fakeGazeY = [414.9576309794988,565.3343052391798,546.6659681093394,503.1494305239179,456.15671981776757,408.0052847380409,363.5875170842824,366.54870159453293,372.2135763097949,371.82733485193614,380.96838268792703,385.3457858769931,385.0882915717539,381.9983599088837,374.40227790432795,370.4111161731206,364.10250569476074,378.90842824601356,391.26815489749424,573.8316173120728,612.1982687927107,583.1014123006833,543.31854214123,509.4580410022778,490.27471526195893,467.2289749430523,465.1690205011389,463.6240546697038,426.41612756264226,435.6859225512528,433.3684738041002,418.82004555808646,406.4603189066058,373.75854214122995,365.00373576309784,361.3988154897493,363.4587699316628,365.6474715261958,367.19243735763087,373.5010478359908,387.01949886104774,385.989521640091,448.818132118451,503.6644191343962,471.73512528473793,478.5587243735762,451.00683371298396,431.95225512528464,397.31927107061495,384.18706150341677,340.67052391799535,411.48145785876983,509.97302961275614,485.63981776765365,383.54332574031883,343.7604555808655,317.3672892938495,262.00601366742586,301.91763097949877,263.4222323462414,270.24583143507965,302.43261958997715,367.19243735763087,390.366924829157,385.3457858769931,382.1271070615033,402.2116628701594,409.0352619589976,401.052938496583,384.83079726651476,374.9172665148063,367.3211845102505,366.29120728929377,451.39307517084274,395.25931662870147,334.2331662870159,364.23125284738035,362.6862870159452,380.58214123006826,388.56446469248283,407.2328018223234,389.07945330296116,394.74432801822314,392.68437357630967,386.11826879271064,372.2135763097949,359.59635535307507,358.05138952164003,372.85731207289285,379.9384054669703,368.737403189066,318.1397722095671,155.53211845102496,58.19927107061494,45.19580865603635,59.35799544419126,56.13931662870149,39.40218678815481,27.299954441913357,-1.5394077448748078,44.03708428246006,160.03826879271062,169.82305239179942,155.53211845102496,188.8776309794988,189.39261958997713,187.0751708428245,194.7999999999999,195.95872437357622,195.701230068337,194.28501138952151,180.76656036446457,183.21275626423682,190.16510250569468,192.09630979498854,366.0337129840546,283.3780410022778,147.93603644646916,176.13166287015935,160.55325740318898,218.10323462414567,123.98906605922542,168.40683371298394,162.87070615034156,148.5797722095671,150.25348519362177,148.70851936218668,148.19353075170835,145.36109339407736];
        // timestamp = [1607231497575,1607231497737,1607231497808,1607231497934,1607231497980,1607231498033,1607231498203,1607231498270,1607231498435,1607231498570,1607231498702,1607231498834,1607231498903,1607231498969,1607231499068,1607231499436,1607231499502,1607231499902,1607231499969,1607231500101,1607231500202,1607231500272,1607231500474,1607231500569,1607231500704,1607231500873,1607231500906,1607231500971,1607231501204,1607231501236,1607231501504,1607231501637,1607231501706,1607231501838,1607231501974,1607231502140,1607231502206,1607231502505,1607231502638,1607231502774,1607231503206,1607231503438,1607231503505,1607231503571,1607231503706,1607231503839,1607231503907,1607231503973,1607231504040,1607231504106,1607231504239,1607231504305,1607231504474,1607231504507,1607231504640,1607231504774,1607231504905,1607231505044,1607231505442,1607231505476,1607231505507,1607231505774,1607231505843,1607231506175,1607231506344,1607231506442,1607231506508,1607231506576,1607231506709,1607231506775,1607231506910,1607231507375,1607231507443,1607231507578,1607231507708,1607231507880,1607231508046,1607231508176,1607231508348,1607231508413,1607231508477,1607231508911,1607231509045,1607231509319,1607231509510,1607231509644,1607231509777,1607231510182,1607231510246,1607231510346,1607231510511,1607231510578,1607231510714,1607231510848,1607231510914,1607231511046,1607231511182,1607231511381,1607231511445,1607231511581,1607231511712,1607231511849,1607231512118,1607231512248,1607231512316,1607231512423,1607231512514,1607231512584,1607231513249,1607231513316,1607231513450,1607231513481,1607231513582,1607231513649,1607231513717,1607231513851,1607231514183,1607231514484,1607231514549,1607231514783,1607231514850,1607231515117,1607231516252,1607231516317,1607231516517,1607231516655,1607231516721,1607231516788,1607231516854]; // not used yet
        // timestamp.forEach((element, i)=>{
        //     if (i != 0) timestamp[i] = timestamp[i] - timestamp[0];
        // });
        // timestamp[0] = 0; // tensorflow.js could not afford numbers as large as timestamp
        // fakeGazeX = fakeGazeX.map( x => x/1413*window.innerWidth);
        // fakeGazeY = fakeGazeY.map( y => y/854*window.innerHeight);
        // Real Gaze (with look back)
        // fakeGazeX = [546.921875, 489.92499999999995, 499.07499999999993, 490.87812499999995, 476.9625, 466.09687500000007, 459.04374999999993, 453.70625000000007, 446.84375, 443.03125, 441.696875, 440.74375, 439.5999999999999, 439.40937500000007, 437.3125, 431.40312499999993, 429.30625, 427.2093749999999, 425.875, 427.2093749999999, 428.54374999999993, 426.446875, 428.1624999999999, 430.0687499999999, 431.2125, 431.9749999999999, 434.8343749999999, 437.12187499999993, 439.40937500000007, 440.93437499999993, 442.26875000000007, 443.603125, 444.17500000000007, 445.12812500000007, 446.08125000000007, 446.2718749999999, 447.2249999999999, 451.0374999999999, 458.6624999999999, 464.953125, 467.8125, 470.671875, 472.0062499999999, 475.8187499999999, 486.3031249999999, 485.15937499999995, 485.921875, 485.3499999999999, 483.634375, 482.68125, 481.34687499999995, 479.821875, 480.39374999999995, 480.01249999999993, 479.25, 477.7249999999999, 476.19999999999993, 475.4375, 474.103125, 473.53125, 474.484375, 473.72187499999995, 472.38749999999993, 472.38749999999993, 472.38749999999993, 470.48124999999993, 469.3375, 468.384375, 466.66874999999993, 464.3812499999999, 463.61875, 461.5218749999999, 459.42500000000007, 457.13749999999993, 454.8499999999999, 453.8968749999999, 456.946875, 459.04374999999993, 460.5687499999999, 462.665625, 453.70625000000007, 452.9437499999999, 451.228125, 450.84687500000007, 450.46562499999993, 451.228125, 451.41874999999993, 451.9906249999999, 452.9437499999999, 464.76249999999993, 477.53437499999995, 488.78125, 501.36249999999995, 513.9437499999999, 528.2406249999999, 529.5749999999999, 537.7718749999999, 543.4906249999999, 547.875, 555.5, 569.2249999999999, 576.0875, 586, 602.203125, 611.925, 621.45625, 630.2249999999999, 640.1374999999999, 729.159375, 768.2375, 800.2624999999999, 838.959375, 887.378125, 917.1156250000001, 903.390625, 903.7718750000001, 892.7156249999998, 885.28125, 873.271875, 873.271875, 872.128125, 871.175, 870.03125, 869.8406249999999, 870.6031249999999, 871.175, 871.7468749999999, 872.890625, 872.6999999999999, 871.9375, 868.6968749999999, 866.7906249999999, 865.646875, 863.9312499999999, 862.596875, 861.2624999999999, 860.5, 860.1187499999999, 860.3093749999999, 860.1187499999999, 832.6687499999999, 822.375, 809.603125, 798.9281249999999, 789.5875, 818.5625, 833.05, 841.2468749999999, 847.346875, 852.6843749999999, 854.971875, 853.828125, 844.678125, 792.6374999999999, 765.5687499999999, 746.696875, 587.7156249999999, 570.1781249999999, 570.5593749999999, 558.359375, 545.015625, 538.915625, 532.625, 527.859375, 529.003125, 527.096875, 528.8125, 526.525, 519.853125, 516.2312499999999, 512.8, 510.51249999999993, 508.415625, 505.9375, 505.3656249999999, 505.3656249999999, 505.55625, 506.890625, 505.9375, 505.74687499999993, 502.88749999999993, 501.93437499999993, 498.50312499999995, 498.12187499999993, 497.359375, 496.21562499999993, 496.7874999999999, 495.64374999999995, 496.025, 496.21562499999993, 496.7874999999999, 502.5062499999999, 506.12812499999995, 509.36875, 523.8562499999999, 520.234375, 530.5281249999999, 528.6218749999999, 508.98749999999995, 496.978125, 493.165625, 487.446875, 486.68437499999993, 493.546875, 499.265625, 500.40937499999995, 502.696875, 503.65, 504.03125, 504.79374999999993, 504.603125, 504.4124999999999, 504.4124999999999, 505.9375, 506.12812499999995, 509.55937499999993, 511.46562499999993, 512.609375, 513.753125, 515.659375, 516.8031249999999, 518.1374999999999, 519.0906249999999, 519.853125, 520.234375, 520.425, 519.28125, 518.7093749999999, 517.7562499999999, 520.234375, 520.234375, 522.33125, 523.4749999999999, 524.2375, 525, 524.61875, 524.61875, 525.953125, 527.2874999999999, 528.2406249999999, 527.859375, 526.7156249999999, 526.7156249999999, 526.7156249999999, 527.2874999999999, 528.05, 528.43125, 529.1937499999999, 527.6687499999999, 527.2874999999999, 532.4343749999999, 575.8968749999999, 681.884375, 838.76875, 926.45625, 924.1687499999998, 938.4656249999998, 942.0874999999999, 946.471875, 946.0906249999998, 946.8531249999999, 947.234375, 946.8531249999999, 942.46875, 941.3249999999998, 938.65625, 936.940625, 935.4156249999999, 935.2250000000001, 931.221875, 928.9343749999998, 926.6468750000001, 921.8812500000001, 916.5437499999998, 912.159375, 909.4906250000001, 891.190625, 885.471875, 872.128125, 868.315625, 855.5437499999999, 858.975, 860.3093749999999, 858.4031249999999, 868.315625, 875.940625, 888.5218750000001, 882.0406249999999, 885.28125, 882.8031250000001, 883.9468749999999, 886.6156250000001, 889.6656249999999, 891, 896.5281249999998, 899.76875, 904.1531249999998, 901.8656250000001, 892.7156249999998, 885.471875, 521.1875, 325.796875, 321.41249999999997, 325.60625, 337.61562499999997];
        // fakeGazeY = [199.46875, 139.23125, 165.53749999999997, 176.78437499999995, 178.88124999999997, 181.93124999999998, 184.98125, 186.125, 184.98125, 184.59999999999997, 186.69687499999998, 187.45937499999997, 188.984375, 191.653125, 190.890625, 189.36562499999997, 192.41562499999998, 194.5125, 197.18124999999998, 199.278125, 198.70624999999995, 201.184375, 203.47187499999995, 204.234375, 206.140625, 208.42812499999997, 210.90624999999994, 210.90624999999994, 213.38437499999998, 214.90937499999995, 215.09999999999997, 217.3875, 218.53124999999994, 218.72187499999995, 218.72187499999995, 219.48437499999994, 219.67499999999995, 232.6375, 257.99062499999997, 278.57812499999994, 294.590625, 312.509375, 335.575, 367.409375, 444.61249999999995, 416.97187499999995, 411.82499999999993, 408.39375, 405.72499999999997, 403.05625, 400.00624999999997, 397.909375, 400.57812499999994, 400.00624999999997, 397.909375, 393.525, 390.09374999999994, 383.80312499999997, 377.51249999999993, 370.45937499999997, 368.93437499999993, 367.59999999999997, 367.02812499999993, 367.02812499999993, 367.21874999999994, 367.409375, 367.409375, 367.790625, 367.409375, 367.02812499999993, 368.3625, 369.50624999999997, 370.65, 372.74687499999993, 375.415625, 375.034375, 370.84062499999993, 367.790625, 363.78749999999997, 359.2125, 371.03124999999994, 375.415625, 378.275, 380.56249999999994, 381.89687499999997, 383.23124999999993, 383.99375, 383.80312499999997, 383.23124999999993, 371.98437499999994, 358.64062499999994, 351.778125, 348.728125, 342.81874999999997, 338.62499999999994, 334.621875, 337.86249999999995, 343.58124999999995, 352.540625, 363.40624999999994, 366.8375, 368.93437499999993, 372.55625, 376.36875, 382.27812499999993, 388.759375, 392.38124999999997, 394.478125, 415.828125, 418.49687499999993, 418.49687499999993, 420.78437499999995, 422.30937499999993, 427.07499999999993, 421.546875, 411.44374999999997, 407.821875, 406.86875, 404.77187499999997, 406.4875, 408.775, 409.15624999999994, 408.96562499999993, 410.10937499999994, 411.44374999999997, 412.20625, 412.20625, 411.82499999999993, 411.44374999999997, 410.87187499999993, 410.10937499999994, 410.68125, 408.58437499999997, 406.67812499999997, 405.915625, 404.009375, 403.43749999999994, 403.24687499999993, 401.91249999999997, 401.91249999999997, 394.66874999999993, 387.23437499999994, 379.03749999999997, 373.69999999999993, 373.89062499999994, 388.56874999999997, 402.103125, 410.68125, 416.4, 421.165625, 420.9749999999999, 414.87499999999994, 398.48124999999993, 386.09062499999993, 375.9875, 356.92499999999995, 279.72187499999995, 271.525, 259.89687499999997, 252.653125, 250.55624999999998, 244.64687499999997, 237.59374999999994, 230.54062499999998, 227.29999999999995, 225.20312499999994, 224.63124999999997, 219.67499999999995, 213.38437499999998, 208.61874999999998, 206.71249999999998, 204.61562499999997, 202.51874999999995, 202.328125, 201.375, 199.08749999999998, 198.13437499999998, 196.99062499999997, 196.99062499999997, 197.75312499999995, 196.79999999999995, 198.13437499999998, 197.371875, 196.22812499999998, 197.75312499999995, 197.75312499999995, 198.325, 199.278125, 200.421875, 201.75624999999997, 203.47187499999995, 221.39062499999994, 235.68749999999994, 252.84374999999994, 340.15, 327.56874999999997, 296.496875, 295.353125, 379.99062499999997, 407.821875, 413.73124999999993, 404.009375, 403.24687499999993, 381.134375, 361.11875, 363.40624999999994, 365.31249999999994, 364.93125, 364.74062499999997, 362.83437499999997, 362.071875, 362.83437499999997, 363.025, 363.78749999999997, 365.884375, 363.596875, 367.02812499999993, 370.45937499999997, 373.509375, 377.51249999999993, 380.37187499999993, 383.23124999999993, 385.32812499999994, 385.9, 386.66249999999997, 387.61562499999997, 387.61562499999997, 386.09062499999993, 382.84999999999997, 382.27812499999993, 383.42187499999994, 384.37499999999994, 385.13749999999993, 386.471875, 387.04374999999993, 387.23437499999994, 388.94999999999993, 389.90312499999993, 390.85624999999993, 391.80937499999993, 390.85624999999993, 391.42812499999997, 391.80937499999993, 391.61875, 392.571875, 391.42812499999997, 391.80937499999993, 391.2375, 388.94999999999993, 387.425, 385.13749999999993, 383.80312499999997, 379.41874999999993, 410.87187499999993, 439.84687499999995, 440.0374999999999, 449.37812499999995, 452.61875, 456.8125, 459.0999999999999, 459.86249999999995, 461.9593749999999, 462.15, 469.775, 472.0625, 472.25312499999995, 472.25312499999995, 471.29999999999995, 471.87187499999993, 470.34687499999995, 468.821875, 466.34375, 463.29374999999993, 460.43437499999993, 459.290625, 483.69062499999995, 480.83124999999995, 449.1875, 462.15, 483.5, 462.53125, 448.6156249999999, 441.37187499999993, 427.8375, 420.78437499999995, 422.69062499999995, 421.35624999999993, 418.1156249999999, 418.1156249999999, 414.30312499999997, 413.34999999999997, 410.10937499999994, 407.821875, 408.01249999999993, 401.34062499999993, 400.76875, 400.00624999999997, 384.946875, 379.8, 379.8, 249.98437499999994, 167.0625, 146.85625, 121.884375, 33.24374999999998];
        // timestamp = [1607841264385, 1607841268576, 1607841268633, 1607841268667, 1607841268733, 1607841268766, 1607841268800, 1607841268833, 1607841268866, 1607841268899, 1607841268933, 1607841268966, 1607841269000, 1607841269032, 1607841269066, 1607841269102, 1607841269136, 1607841269169, 1607841269202, 1607841269235, 1607841269269, 1607841269303, 1607841269338, 1607841269403, 1607841269451, 1607841269484, 1607841269536, 1607841269577, 1607841269599, 1607841269632, 1607841269665, 1607841269699, 1607841269732, 1607841269765, 1607841269816, 1607841269849, 1607841269883, 1607841269932, 1607841269966, 1607841270032, 1607841270065, 1607841270099, 1607841270133, 1607841270183, 1607841270215, 1607841270249, 1607841270283, 1607841270332, 1607841270365, 1607841270399, 1607841270432, 1607841270465, 1607841270498, 1607841270548, 1607841270582, 1607841270615, 1607841270648, 1607841270699, 1607841270732, 1607841270765, 1607841270805, 1607841270833, 1607841270865, 1607841270917, 1607841270952, 1607841270984, 1607841271018, 1607841271052, 1607841271083, 1607841271117, 1607841271150, 1607841271201, 1607841271233, 1607841271284, 1607841271317, 1607841271350, 1607841271384, 1607841271416, 1607841271449, 1607841271482, 1607841271532, 1607841271571, 1607841271615, 1607841271648, 1607841271681, 1607841271715, 1607841271748, 1607841271781, 1607841271815, 1607841272176, 1607841272215, 1607841272248, 1607841272281, 1607841272314, 1607841272348, 1607841272382, 1607841272415, 1607841272448, 1607841272481, 1607841272515, 1607841272550, 1607841272581, 1607841272614, 1607841272647, 1607841272683, 1607841272732, 1607841272780, 1607841272813, 1607841272847, 1607841272880, 1607841272915, 1607841272948, 1607841272982, 1607841273015, 1607841273048, 1607841273462, 1607841273496, 1607841273530, 1607841273584, 1607841273646, 1607841273680, 1607841273714, 1607841273747, 1607841273796, 1607841273831, 1607841273864, 1607841273897, 1607841273931, 1607841273980, 1607841274012, 1607841274046, 1607841274080, 1607841274113, 1607841274167, 1607841274197, 1607841274230, 1607841274263, 1607841274297, 1607841274332, 1607841274381, 1607841274748, 1607841274780, 1607841274812, 1607841274846, 1607841274896, 1607841274929, 1607841274962, 1607841274996, 1607841275029, 1607841275063, 1607841275096, 1607841275130, 1607841275180, 1607841275212, 1607841275263, 1607841275296, 1607841275329, 1607841275362, 1607841275396, 1607841275429, 1607841275462, 1607841275496, 1607841275529, 1607841275569, 1607841275629, 1607841275662, 1607841275695, 1607841275729, 1607841275762, 1607841275795, 1607841275829, 1607841275863, 1607841275896, 1607841275929, 1607841275962, 1607841275995, 1607841276029, 1607841276062, 1607841276435, 1607841276495, 1607841276529, 1607841276568, 1607841276629, 1607841276662, 1607841276712, 1607841276746, 1607841276779, 1607841276829, 1607841276862, 1607841276896, 1607841276929, 1607841276962, 1607841276995, 1607841277029, 1607841277079, 1607841277112, 1607841277145, 1607841277178, 1607841277229, 1607841277262, 1607841277295, 1607841277712, 1607841277778, 1607841277811, 1607841277844, 1607841277877, 1607841277911, 1607841277945, 1607841277977, 1607841278027, 1607841278061, 1607841278094, 1607841278144, 1607841278177, 1607841278211, 1607841278244, 1607841278278, 1607841278311, 1607841278344, 1607841278378, 1607841278427, 1607841278461, 1607841278511, 1607841278544, 1607841278578, 1607841278610, 1607841278644, 1607841279020, 1607841279077, 1607841279114, 1607841279147, 1607841279180, 1607841279214, 1607841279247, 1607841279280, 1607841279313, 1607841279347, 1607841279381, 1607841279412, 1607841279446, 1607841279478, 1607841279510, 1607841279544, 1607841279594, 1607841279643, 1607841279677, 1607841279711, 1607841279743, 1607841279777, 1607841279810, 1607841279877, 1607841279914, 1607841279963, 1607841280325, 1607841280360, 1607841280393, 1607841280426, 1607841280476, 1607841280509, 1607841280545, 1607841280581, 1607841280609, 1607841280642, 1607841280693, 1607841280727, 1607841280760, 1607841280793, 1607841280826, 1607841280876, 1607841280909, 1607841280942, 1607841280976, 1607841281009, 1607841281059, 1607841281092, 1607841281126, 1607841281159, 1607841281193, 1607841281226, 1607841281275, 1607841281609, 1607841281643, 1607841281675, 1607841281709, 1607841281759, 1607841281792, 1607841281825, 1607841281858, 1607841281892, 1607841281925, 1607841281959, 1607841281992, 1607841282028, 1607841282076, 1607841282126, 1607841282159, 1607841282192, 1607841282258, 1607841282292, 1607841282359, 1607841282425, 1607841282567, 1607841282592, 1607841282658, 1607841283091];
        // timestamp.forEach((element, i) => {
        //     if (i != 0) timestamp[i] = timestamp[i] - timestamp[0];
        // });
        // timestamp[0] = 0; // tensorflow.js could not afford numbers as large as timestamp
        // fakeGazeX = fakeGazeX.map(x => x / 1464 * window.innerWidth);
        // fakeGazeY = fakeGazeY.map(y => y / 794 * window.innerHeight);

        // fakeGazeX.forEach((x, index) => {
        //     ctx.fillStyle = 'red';
        //     ctx.beginPath();
        //     ctx.arc(x, fakeGazeY[index], 5, 0, Math.PI * 2, true);
        //     ctx.fill();
        //     ctx.fillText(index, x+5, fakeGazeY[index]+5);
        // });

        sleep(100).then(() => {
            startFixation(fakeGazeX, fakeGazeY, timestamp)
        });

    }

    function drawAnchors() {
        anchorsX = [64, 64, 950, 950, 507]
        anchorsY = [64, 516, 64, 516, 290]
        for (var i=0; i<anchorsX.length; ++i) {
            ctx.fillStyle = 'blue';
            ctx.beginPath();
            ctx.arc(anchorsX[i], anchorsY[i], 20, 0, Math.PI * 2, true);
            ctx.fill();
            // ctx.fillText(gazeCounter, anchorsX[i], anchorsY[i]);
        }
    }

    function toggleClick() {
        function clickHandler(e) {
            fakeGazeX.push(e.clientX - xOffset);
            fakeGazeY.push(e.clientY - yOffset);

            // console.log(e.clientX - xOffset, e.clientY - yOffset)

            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(e.clientX - xOffset, e.clientY - yOffset, 5, 0, Math.PI * 2, true);
            ctx.fill();
            ctx.fillText(gazeCounter, e.clientX - xOffset + 5, e.clientY - yOffset + 5);

            gazeCounter += 1;
        }

        canvas.addEventListener("click", clickHandler);

        let btn = document.getElementById('toggle_click');
        beginClick = !beginClick;

        if (beginClick) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawAnchors()
            btn.innerHTML = 'Stop click samples';
        } else {
            canvas.removeEventListener("click", clickHandler);
            gazeCounter = 0;

            btn.innerHTML = 'Begin click samples';
            console.log('Click record stopped.');
            console.log(fakeGazeX.toString());
            console.log(fakeGazeY.toString());

            sleep(100).then(() => {
                startFixation(fakeGazeX, fakeGazeY, new Array(fakeGazeX.length).fill(1).map((item, index) => index))
            });
        }
    }

    function toggleGazeCloud() {
        let btn = document.getElementById('toggle_gazeCloud');
        beginGazeCloud = !beginGazeCloud;

        if (beginGazeCloud) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawAnchors();
            btn.innerHTML = 'Stop GazeCloud';
            document.getElementById("gazecloudopts").style.display = 'initial';
        } else {
            btn.innerHTML = 'Begin GazeCloud';
            document.getElementById("gazecloudopts").style.display = 'none';
            console.log('Gaze record stopped.');

            timestamp = timestamp.slice(0, timestamp.length - 1).map((item, index) => timestamp[index+1] - item);
            timestamp.unshift(0); // tensorflow.js could not afford numbers as large as timestamp

            console.log('real gaze x', realGazeX.toString());
            console.log('real gaze y', realGazeY.toString());
            console.log('timestamp', timestamp.toString());

            sleep(100).then(() => {
                startFixation(realGazeX, realGazeY, timestamp)
            });
        }
    }

    const returnAttributes = ['emotion', 'eyegaze'].join(',');
    function toggleFacePlusPlus() {
        ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
        let base64ImageData = canvas.toDataURL();
        let timestamp = Date.now();

        let formData  = new FormData();
        formData.append('api_key', fpp_API_key);
        formData.append('api_secret', fpp_API_secret);
        formData.append('image_base64', base64ImageData);
        formData.append('return_landmark', 2);
        formData.append('return_attributes', returnAttributes);
        // CLI quick test: curl -X POST "https://api-cn.faceplusplus.com/facepp/v3/detect" -F "api_key=5PxRvIfMnvXCjYh6nCnbAp4-vQuGVQQW" -F "api_secret=vcj_t3_KhOtvvY5I4UT5qZUhHxaYbQeG" -F "image_file=@1_998.jpg" -F "return_landmark=2" -F "return_attributes=emotion,eyegaze"

        fetch(fpp_url, {
            method: 'POST',
            body: formData,
        }).then(res => res.json())
        .then(res => {
            toggleFacePlusPlus(); // request again after
            if (res.faces.length === 0) {
                // no face is detected, possibly due to bad angle or the user has left
                PlotGaze({
                    state: -1,
                    docX: 1,
                    docY: 1,
                    time: timestamp,
                })
            } else {
                // face is detected
                let face = res.faces[0];
                let emotion = face.attributes.emotion;
                let gaze = vector2plane(face.attributes.left_eye_gaze, face.attributes.right_eye_gaze);
                PlotGaze({
                    state: 0,
                    ...gaze,
                    time: timestamp,
                })
            }
        }).catch(e => console.log(e));
    }

    function vector2plane(leftEyeGaze, rightEyeGaze, distance) {
        let left_eye_x = leftEyeGaze.position_x_coordinate;
        let left_eye_y = leftEyeGaze.position_y_coordinate;
        let left_vector = tf.tensor1d([leftEyeGaze.vector_x_component, leftEyeGaze.vector_y_component, leftEyeGaze.vector_z_component]);

        let right_eye_x = rightEyeGaze.position_x_coordinate;
        let right_eye_y = rightEyeGaze.position_y_coordinate;
        let right_vector = tf.tensor1d([rightEyeGaze.vector_x_component, rightEyeGaze.vector_y_component, rightEyeGaze.vector_z_component]);
    }

    function PlotGaze(GazeData) {
        /*
            GazeData.state // 0: valid gaze data; -1 : face tracking lost, 1 : gaze uncalibrated
            GazeData.docX // gaze x in document coordinates
            GazeData.docY // gaze y in document cordinates
            GazeData.time // timestamp
        */

        var canvasX = GazeData.docX - xOffset;
        var canvasY = GazeData.docY - yOffset;
        var time = GazeData.time;

        if (GazeData.state == 0) {

            if (lastGazeTs < 0) {
                lastGazeTs = time;
            } else if (time - lastGazeTs >= 500) {
                lastGazeTs = time;
            } else {
                return;
            }

            realGazeX.push(canvasX);
            realGazeY.push(canvasY);
            timestamp.push(time);

            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(canvasX, canvasY, 5, 0, Math.PI * 2, true);
            ctx.fill();
            console.log(`@(${GazeData.docX},${GazeData.docY})`);

            var gaze = document.getElementById("gaze");
            gaze.style.left = GazeData.docX - gaze.clientWidth / 2 + "px";
            gaze.style.top = GazeData.docY - gaze.clientHeight / 2 + "px";


            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(canvasX, canvasY, 5, 0, Math.PI * 2, true);
            ctx.fill();
            ctx.fillText(gazeCounter, canvasX + 5, canvasY + 5);

            gazeCounter += 1;

        } else {
            console.log(GazeData.state > 0 ? 'gaze uncalibrated' : 'face tracking lost');
        }
    }

    async function startFixation(gazeX, gazeY, timestamp) {
        let samples = {
            x: gazeX,
            y: gazeY,
            t: timestamp, // not used right now
        };

        // // LAMBDA = 6
        // [fixations, saccades] = detectFixations(samples);
        // // Visualize fixations
        // fixations.forEach((fixation, id) => {
        //     fixation.draw(ctx);
        //     fixation.drawId(ctx, id);
        //     fixation.drawRectArea(ctx);
        //     // console.log(`#${id} fixation, ${Date(fixation.start)}, Duration : ${fixation.duration.dataSync()}ms`);
        // });
        // // Visualize saccades
        // saccades.forEach((saccade, id) => {
        //     saccade.drawVelocity(ctx);
        //     console.log(`#${id} saccade`);
        // });

        // LAMBDA = 3
        [fixations_ori, saccades] = detectFixations(samples, 3);
        fixations = [];
        fixations_ori.forEach((fix, id) => {
            if (fix.data.xvar_per > 7.5 && fix.data.yvar_per > 7.5) {
                console.log('discard: ', id)
            } else {
                fixations.push(fix);
            }
            console.log(`fix.var_per:${id}`, fix.data.xvar_per, fix.data.yvar_per)
            // fixations.push(fix);
        });
        // // Visualize fixations
        fixations.forEach((fixation, id) => {
            fixation.draw(ctx, r=10, color='green');
            fixation.drawId(ctx, id);
            fixation.drawRectArea(ctx, color='green');
            // console.log(`#${id} fixation, ${Date(fixation.start)}, Duration : ${fixation.duration}ms`);
            // console.log(`#${id} fixation, X: ${fixation.x}, Y: ${fixation.y}`);
        });
        // Visualize saccades
        // saccades.forEach((saccade, id) => {
        //     saccade.drawVelocity(ctx);
        //     console.log(`#${id} saccade`);
        // });

        console.log('============Fixations============');
        // console.log(fixations);

        let fixations_x = []
        let fixations_y = []

        fixations.forEach((fixation, id) => {
            fixations_x.push(fixation.data.x_per);
            fixations_y.push(fixation.data.y_per);
        })
        console.log('fx:', fixations_x.toString())
        console.log('fy:', fixations_y.toString())

        // console.log(JSON.stringify(fixations))//.map(fixation => fixation.toPercentage())));

        // AoI and T-matrix
        let classes = await fetch('http://127.0.0.1:8000/clustering', {//'/gazeData/cluster', {
            method: 'POST',
            // headers: {
            //     'Content-Type': 'application/json;charset=utf-8'
            // },
            body: JSON.stringify(fixations),//JSON.stringify(fixations.map(fixation => fixation.toPercentage())),
        })
            .then(res => res.json())
            .then(result => result.result)//JSON.parse(result.result))
            .catch(err => console.error(err));

        console.log('============Classification of fixations============');
        console.log(classes);
        [AoIs, TMatrix] = AoIBuilder(fixations, saccades, classes);

        console.log('============AoIs============');
        console.log(AoIs);
        console.log('============TMatrix============');
        console.log(TMatrix);

        let animationTime = 1000; //ms
        showAoI(AoIs, animationTime);
        showTransition(AoIs, TMatrix, animationTime);
    }

    function sleep(time) {
        return new Promise((resolve) => setTimeout(resolve, time));
    }

    // function resize() {
    //     var canvas = document.getElementById('plotting_canvas');
    //     var context = canvas.getContext('2d');
    //     context.clearRect(0, 0, canvas.width, canvas.height);
    //     canvas.width = window.innerWidth;
    //     canvas.height = window.innerHeight;
    // };
    // window.addEventListener('resize', resize, false);
</script>

</body>

</html>